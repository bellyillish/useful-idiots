# "Полезные Идиоты" для GAMMA и Anomaly

Преобразует систему компаньонов, добавляет новые и улучшенные команды, настраиваемые горячие клавиши, новый UI, а также вносит ряд исправлений и тонких настроек поведения компаньонов.

*Не перезаписывает (и, надеемся, никогда не будет) никакие основные файлы, чтобы не конфликтовать с другими модами.*

## UI

Новый интерфейс заменяет собой колесо компаньонов (привязан к той же клавише). Работает похожим образом: когда вы нацелены на компаньона, команды применяются только к нему; когда не нацелены ни на кого - команды применяются ко всем компаньонам сразу.
- Показывает все команды для управления компаньонами в одном месте
- Всегда указывает, какие команды установлены глобально, а какие для каждого конкретного компаньона
- Вкладки позволяют в любой момент перейти к глобальным настройкам или к настройкам отдельного компаньона
- Когда UI открыт, над компаньонами отображаются числовые индикаторы, показывающие номер их вкладки (можно отключить в MCM)

**Включает в себя следующие команды (подробности по каждой ниже):**
- [Движение](#движение): следовать за мной, ждать, найти укрытие, отдыхать, патрулировать
- [Построение](#построение): вместе, врассыпную, колонна, в укрытии
- [Положение](#положение): встать, присесть, лечь
- [Дистанция](#дистанция): держаться рядом, нормально, держаться вдалеке
- [Поведение](#поведение): игнорировать бой, ответный огонь, атаковать всех
- [Режим боя](#режим-боя): обычный (по умолчанию), агрессивный, поддержка, оборонительный, снайпер
- [Оружие](#оружие): лучшее, пистолет, дробовик, пистолет-пулемет, штурмова явинтовка, снайперская винтовка, РПГ
- [Фонарик](#фонарик): стандартное поведение фонарика (авто), включён, выключен
- [Переключатели задач](#переключатели-задач): спешить, собирать предметы, собирать артефакты*, обыскивать трупы, помогать раненым
- [Кнопки](#кнопки): добавить точку, очистить все точки, инвентарь, перезарядка\*, отступление\*, освободить/«раззастрять»\*, синхронизировать всех/повторно

\* = *по умолчанию отключено в MCM*

## Горячие клавиши

Вы можете настроить горячие клавиши для любых из вышеперечисленных команд. Также есть несколько дополнительных команд, которые доступны только через горячие клавиши:

- **Выбрать компаньона:** Позволяет выбрать одного или несколько компаньонов при помощи курсора. Последующие нажатия горячих клавиш будут влиять только на выбранных компаньонов, а не на всех.
- **Очистить всех выбранных компаньонов:** Снимает выделение со всех компаньонов. Последующие нажатия горячих клавиш вновь будут влиять на всех.
- **Добавить точку:** Добавляет точку маршрута в то место, куда указывает курсор.
- **Переместиться на точку:** Перемещает компаньонов туда, куда указывает курсор (поведение такое же, как у горячей клавиши Anomaly).
- **Смотреть на точку:** Заставляет компаньонов смотреть туда, куда указывает курсор.
- **Уйди с дороги:** Заставляет компаньонов рядом с курсором отойти в сторону и освободить путь игроку.

## Команды

### Движение
---
> [!NOTE]
> Влияет на компаньонов, когда они не в бою.

- **Следовать за мной:** Идут за игроком в выбранном в UI построении. Похоже на ванильное поведение, но с переписанной логикой маршрутов.
  - Вместо передвижения в нескольких группах они перемещаются более скоординированно, как единый отряд, где вы – командир.
  - Они подчиняются команде «Переместиться на точку», но возобновляют команду «Следовать за мной», как только игрок сдвинется с места. Через MCM можно настроить, чтобы «Переместиться на точку» автоматически переключало их на «Ждать».
  - Компаньоны автоматически используют бег, приседание, ложатся и меняют состояние фонариков в соответствии с игроком (всё это можно отключить в MCM).
  - Компаньоны определяют, на открытой ли территории сейчас игрок, в обычном помещении или в тесном пространстве, и следуют/не следуют в зависимости от местоположения. В помещении они предпочитают оставаться по ту же сторону препятствия (например стены), что и игрок. Они стараются не заходить в тесное пространство, если не установлено «Держаться рядом».

- **Ждать:** Немедленно останавливаются и остаются на текущей позиции. Похоже на ванильное поведение. Спустя несколько секунд они перестают смотреть на игрока и переводят взгляд в фиксированном направлении. Можно заставить их смотреть в определённом направлении с помощью «Смотреть на точку». При использовании «Переместиться на точку» они направятся к обозначенной точке и будут ждать там.

- **Найти укрытие:** Пытаются найти подходящее укрытие поблизости и ждать там. Если поблизости нет укрытия, остаются на текущей позиции. При использовании «Переместиться на точку» ищут укрытие возле этой точки.

- **Отдыхать:** Пытаются найти поблизости костёр с местом, чтобы сесть/присесть на корточки. Если такого костра нет или все места заняты, выбирают произвольную точку рядом (обычно внутри помещения, у стены или у другого крупного объекта). Это поведение не привязано к схемам лагерей, поэтому компаньоны могут использовать любой ближайший костёр, в том числе тот, который вы разместили сами (при наличии мода, позволяющего это делать). При использовании «Переместиться на точку» они будут отдыхать рядом с этой точкой.

- **Патрулировать:** Патрулируют между 2 или более точками. Похоже на ванильное поведение, но они продолжают патрулировать по циклу, а не останавливаются на последней точке. Компаньоны могут быть переведены в «Патрулировать» только при наличии как минимум двух установленных точек (с помощью «Добавить точку»).
Кроме того, компаньоны могут выполнять различные анимации. Они начинают все больше "скучать" по мере патрулирования, и рано или поздно вы можете увидеть, как они курят или сидят без дела. Когда они отдыхают, они могут есть, пить, доставать PDA или даже спать.

### Построение
---
> [!NOTE]
> Влияет на компаньонов, находящихся в режиме «Следовать за мной» и не участвующих в бою. Устанавливаются только глобально во вкладке «Все».

- **Вместе:** Следуют за игроком в рандомном, компактном построении, похоже на ванильное.
- **Врассыпную:** Следуют за игроком, двигаясь бок о бок в линию.
- **Колонна:** Следуют за игроком колонной друг за другом.
- **В укрытии:** Следуют за игроком, стараясь максимально держаться укрытий.

### Положение
---
> [!NOTE]
> Влияет на компаньонов в состояниях бездействия, в режиме «Следовать за мной» или в бою (боевая логика иногда переопределяет их позу).

- **Встать:** Стоять/ходить/бегать (то же, что в ванили не в режиме скрытности).
- **Присесть:** Приседать/красться (как в ванили при использовании стелса).
- **Лечь:** Лечь/ползти (анимаций для передвижения в положении лёжа, насколько нам известно, не существует).

### Дистанция
---
> [!NOTE]
> Влияет на компаньонов, которые находятся в режиме «Следовать за мной» или в режиме боя «Поддержка». Ниже описаны расстояния для режима «Следовать за мной».

- **Держаться рядом:** Держаться минимум в ~2,5 м от игрока.
- **Нормально:** Держаться минимум в ~5 м от игрока.
- **Держаться вдалеке:** Держаться минимум в ~10 м от игрока.

### Поведение
---
- **Атаковать всех:** Атаковать врагов при обнаружении (как в ванили).
- **Ответный огонь:** Атаковать только если враг нападает на игрока (аналогично «Не атаковать, пока не нападут» в ванили).
- **Игнорировать бой:** Всегда игнорировать врагов (как в ванили).

### Режим боя
---
> [!NOTE]
> Все пользовательские режимыы боя включают в себя следующее:
> - Уклонение от гранат (без выхода из боя)
> - Избегание дружественного огня (с минимальным прерыванием боя)
> - Атаки в ближнем бою при близком расстоянии
> - Использование слуха для обнаружения врагов
> - Обмен информацией о местоположении врагов между собой и при подсветке от игрока
> - Поиск лучшего укрытия (высокого, среднего или низкого) в зависимости от ситуации
> - Приседание или стояние для стрельбы из-за укрытий или чтобы спрятаться за ними
> - Использование метода "трассировки луча" *(raycasting)*, чтобы улучшить зрение через препятствия (например прозрачные аномалии)

- **Обычный (Anomaly):** Отключает боевую логику мода и использует стандартную схему боя движка Anomaly.

- **Агрессивный:** Атакующий стиль боя. Компаньоны постепенно сокращают дистанцию до врага до оптимальной для их активного оружия, предпочитая укрытия, из-за которых можно вести огонь. Преследуют врага, если тот зашёл в помещение (например, в здание). Если враг сосредоточен на другом NPC, они пытаются зайти во фланг. При столкновении с мутантами они пятятся и уклоняются, одновременно стреляя. Если теряют врага из виду, начинают поиск с его последней известной позиции. Добивают раненых врагов. При получении ранений отходят назад и ищут более надёжное укрытие.

- **Оборонительный:** Оборонительный стиль боя. Компаньоны сражаются с врагом, оставаясь в радиусе своей изначальной позиции, защищая/охраняя её. Периодически меняют позицию, чтобы восстановить визуальный контакт с врагом или найти лучшее укрытие. При столкновении с мутантами уклоняются. Добивают раненых врагов внутри  радиуса от изначальной позиции.

- **Поддержка:** Компаньоны сражаются, оставаясь в радиусе вокруг игрока, оказывая поддерживающий огонь. Периодически меняют позицию, чтобы восстановить визуальный контакт с врагом или найти лучшее укрытие. При столкновении с мутантами уклоняются. Добивают раненых врагов, находящихся в их радиусе. Следуют правилам дистанции «Держаться рядом», «Нормально», «Держаться вдалеке», оставаясь на 8 м / 16 м / 24 м от игрока соответственно. По возможности стараются не попадать на линию огня между игроком и врагом.

- **Снайпер:** Компаньоны остаются на текущей фиксированной позиции. Двигаются только для уклонения от гранат или для избежания дружественного огня, независимо от того, сражаются они с NPC или мутантами.

Боевые режимы реагируют на команду «Переместиться на точку» в соответствии с их логикой. Например, в режимах боя «Оборонительный» или «Снайпер» эта точка становится новой постоянной позицией. В режимах «Агрессивный» или «Поддержка» они переместятся в указанную точку, но затем продолжат обычное боевое поведение. Через MCM можно настроить, чтобы команда «Переместиться на точку» автоматически переводило их в режим боя «Оборонительный».

> [!WARNING]
> Также в МСМ можно включить боевые режимы **«Монолит»**, **«Меткий стрелок»** и **«Зомби»**, идущие в комплекте с Anomaly, но не использующиеся напрямую. В целом они работают, но могут выглядеть странно и глючно, поэтому **отключены по умолчанию и официально в моде не поддерживаются**. Считайте это "бонусным контентом".

### Оружие
---
> [!NOTE]
> В ванильной версии игры компаньоны переключают оружие в зависимости от дистанции до врага. Это поведение определяется движком и может происходить в совершенно неподходящие моменты, например: оказываясь на границе двух дистанций, компаньоны могут бесконечно переключаться туда-сюда между типами оружия и застревать в анимации перезарядки, которая прерывается очередным переключением, не успев завершиться. Это делает их уязвимыми и не способными защищаться.

При выборе **«Лучшее»** компаньоны всегда используют самое лучшее из имеющегося оружия. То, какое оружие считается «Лучшим», определяется по:
1. Уровню набора для ремонта (оружие без набора для ремонта, например РПГ, считается лучшим)
2. Среди оружия с одинаковым набором для ремонта «лучшим» считается то, у которого выше стоимость

Также можно приказать использовать определённый тип оружия: «Пистолет», «Дробовик», «Пистолет-пулемет», «Штурмовая винтовка», «Снайперская винтовка» или «РПГ». Но независимо от выбора, компаньоны не меняют оружие во время боя, пока вы не прикажете.

### Фонарик
---
- **Стандартное поведение фонарика (авто):** Позволить ванильной игре или другим модам управлять фонарями.
- **Фонарик ВЫКЛ:** Принудительно выключить фонари.
- **Фонарик ВКЛ:** Принудительно включить фонари.

В режиме «Следовать за мной» компаньоны будут копировать состояние фонаря игрока при выбранном режиме «Стандартное поведение фонарика (авто)» (если это не переопределено другим модом). Это поведение можно отключить в MCM.

### Переключатели задач
---
- **Спешить:** Бежать к цели.
- **Собирать предметы:** Подбирать предметы, лежащие в мире игры.
- **Собирать артефакты:** Собирать артефакты (становится доступным для включения только если «Собирать предметы» включено).
- **Обыскивать трупы:** Обыскивать ближайшие трупы.
- **Помогать раненым:** Оказывать первую помощь раненым дружественным NPC (в том числе в бою).

Все предметы, которые компаньоны собирают при включенных задачах «Собирать предметы» / «Обыскивать трупы», можно взять у них из инвентаря. Все остальные предметы, которые они имеют при себе, остаются скрытыми от игрока (как в ванилле).

> [!IMPORTANT]
> Если вы хотите использовать эти команды, убедитесь, что отключили любые моды, которые мешают или запрещают NPC подбирать добычу. Также вы можете настроить в MCM, могут ли остальные NPC (кроме компаньонов) подбирать и собирать предметы. По умолчанию это отключено для GAMMA, но включено в остальных случаях.

> [!CAUTION]
> Поскольку NPC неуязвимы к аномалиям, «Собирать артефакты» является читерской функцией. Рекомендуется включать её только при использовании модов, которые компенсируют это (например, мод, заставляющий NPC избегать аномалий и/или получать урон от них).

### Кнопки
---
- **Добавить точку:** Добавляет точку маршрута для компаньона. Можно поставить его на «Патрулирование» при наличии как минимум двух точек.
- **Очистить все точки:** Удаляет все точки маршрута и выводит компаньона из режима «Патрулирование», если он был включён.
- **Инвентарь:** Открывает инвентарь компаньона. Компаньон должен находиться не дальше 8 м от игрока.
- **Перезарядка:** Заставляет компаньонов перезарядить всё пустое или частично заряженное оружие в их инвентаре. Повторное нажатие отменяет процесс перезарядки. По умолчанию скрыта, но может быть включена в MCM.
- **Быстрое отступление:** Одновременно включает «Следовать за мной», «Спешить», «Игнорировать бой» и «Держаться рядом». Полезно в экстренных ситуациях, заставляет компаньонов выйти из боя и бежать к вам. По умолчанию скрыта, но может быть включена в MCM.
- **Освободить/"раззастрять":** Запускает функцию мода, которая может помочь, если компаньоны застряли или не реагируют на команды. По умолчанию скрыта, но может быть включена в MCM.
- **Синхронизировать всех/повторно:** Сбрасывает состояние всех компаньонов на глобальное (то, что указано во вкладке «Все» в UI).

## Другие улучшения ИИ

### ИИ дружественного огня
---
> [!NOTE]
> Ванильная система дружественного огня (`rx_ff.script`) сильно мешает NPC во время боя. Когда вы видите, как NPC бегают из стороны в сторону, не стреляя — это пример такой ситуации. Поясню подробнее: как только дружественный или нейтральный NPC оказывается на линии огня, NPC сразу выходят из боя, двигаются в сторону на 10–12 метров и не возвращаются в бой минимум 2,5 секунды. Более того, логика уклонения чаще всего предпочитает одно направление движения, из-за чего несколько NPC могут перемещаться в одну и ту же сторону и продолжать мешать друг другу, замедляя возвращение к бою. Поэтому массовые перестрелки часто выглядят как цирковое шоу, а не как реалистичный бой.

"Полезные Идиоты" **меняет и улучшает поведение системы дружественного огня**, при этом не слишком ломая поведение ИИ или баланс:

1. Когда дружественный/нейтральный NPC попадает на линию огня, существует 1,5-секундная «пауза», прежде чем NPC начнет двигаться в сторону. В течение этого времени они просто перестают стрелять и сразу продолжают бой, как только линия огня освобождается.

2. Если спустя 1,5 с линия огня всё ещё занята, они смещаются в сторону на более короткую дистанцию. Если в процессе перемещения линия огня освобождается, они прекращают движение и возвращаются к бою уже через 500 мс, не дожидаясь стандартных 2,5 секунд.

Для компаньонов улучшенная логика дружественного огня встроена в [пользовательские режимы боя](#режим-боя) и работает почти так же. Единственное отличие от общей логики — направление уклонения выбирается более случайным образом.

### ИИ перезарядки
---
> [!NOTE]
> Ещё одна проблема, снижающая эффективность боя у NPC — их поведение при перезарядке. Помимо того, что движок может заставлять их переключаться на оружие без патронов или зацикливаться на перезарядке, также они обычно не перезаряжают оружие после окончания боя или при выходе из него. Когда начинается новый бой, им приходится тут же перезаряжаться, становясь уязвимыми.

Помимо улучшенного [механизма переключения оружия](#оружие), "Полезные Идиоты" добавляет два элемента к логике поведения NPC, связанной с перезарядкой:
1. Компаньоны автоматически перезаряжают активное оружие после выхода из боя, при первом присоединении к отряду игрока или при загрузке сохранения (через MCM можно настроить, чтобы они перезаряжали всё своё оружие или только активное).
2. Компаньоны автоматически перезаряжают оружие во время боя перед началом поиска врага.

## Исправления

"Полезные Идиоты" исправляет множество багов, ошибок, несоответствий и странностей в поведении компаньонов. Теперь они ощущаются более живыми и отзывчивыми, лучше строят маршруты, уважают личное пространство игрока и реже застревают. Находясь в скрытности, они больше не игнорируют врагов ближе 30 метров (и наоборот). Они перестали внезапно останавливаться, все время жутко пялиться на игрока и игнорировать команды, если вы стоите рядом. Многие параметры отредактированы или переработаны через DLTX.
